学习测试驱动开发(Test-Driven Development,TDD)

来源：《Python Web开发：测试驱动方法》

---

# 笔记

# 功能测试

- 功能测试（Function Test）
- 验收测试（Acceptance Test）
- 端到端测试（End-to-End Test）
- 黑箱测试（Black Box Test）

# 有用的 TDD 概念
- 用户故事
  - 从用户的角度描述应用应该如何运行。用来组织功能测试。

- 预期失败
  - 意料之中的失败。

# 单元测试及其与功能测试的区别
功能测试站在用户的角度从外部测试应用,单元测试则站在 程序员的角度从内部测试应用。

# TDD编写测试流程

- 1. 先写功能测试，从用户的角度描述应用的新功能
- 2. 功能测试失败后,想办法编写代码让它通过(或者说至少让当前失败的测试通过)。此时,使用一个或多个单元测试定义希望代码实现的效果,保证为应用中的每一行代码 (至少)编写一个单元测试。
- 3. 单元测试失败后,编写最少量的应用代码,刚好让单元测试通过。有时,要在第2步和第3步之间多次往复,直到我们觉得功能测试有一点进展为止。
- 4. 然后,再次运行功能测试,看能否通过,或者有没有进展。这一步可能促使我们编写一些新的单元测试和代码等。

### Tips: 每一次修改的代码要尽量少,让失败的测试通过即可。

### Tips: 遵守“不测试常量”规则（单元测试的规则之一是“不测试常量”。以文本形式测试 HTML 很大程度上就是测试常量。），单元测试要测试的其实是逻辑、流程控制和配置。编写断言检测 HTML字符串中是否有指 定的字符序列,不是单元测试应该做的。

# TDD流程
- 功能测试；
- 单元你测试；
- “单元测试/编写代码”循环；
- 重构。

# 程序中添加空行
```python
def test_home_page_can_save_a_POST_request(self):
    request = HttpRequest()
    request.method = 'POST'
    request.POST['item_text'] = 'A new list item'

    response = home_page(request)
    self.assertIn('A new list item', response.content.decode())
```
你想知道为什么要在测试中添加一个空行吗?我把开头三行放在一起,作用是设置测试的背景;然后在中间添加一行调用要测试的函数;最后编写断言。这么做并不是强制要求,但可以看清测试的结构。“设置配置 - 执行代码 - 编写断言”是单元测试的典型结构。

# “遇红 / 变绿 / 重构”和三角法
“单元测试 / 编写代码”循环有时也叫“遇红 / 变绿 / 重构”:
- 先写一个会失败的单元测试(遇红);
- 编写尽可能简单的代码让测试通过(变绿),就算作弊也行;
- 重构,改进代码,让其更合理。

# 事不过三,三则重构
编程中有个原则叫作“不要自我重复”(Don’t Repeat Yourself, DRY),按照真言“事不过三,三则重构”的说法,运用这个原则。复制粘贴一次,可能还不用删除重复,但如果复制粘贴了三次,就该删除重复了。

# 更好的单元测试实践方法:一个测试只测试一件事
现在视图函数处理完 POST 请求后会重定向,这是习惯做法,而且单元测试也一定程度上缩短了,不过还可以做得更好。良好的单元测试实践方法要求,一个测试只能测试一件事。因为这样便于查找问题。如果一个测试中有多个断言,一旦前面的断言导致测试失 败,就无法得知后面的断言情况如何。下一章会看到,如果不小心破坏了视图函数,我们想知道到底是保存对象时出错了,还是响应的类型不对。
